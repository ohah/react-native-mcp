# E2E CI 안정성

GitHub Actions에서 E2E 테스트가 가끔 실패하는 경우(flakiness)와 대응 방법.

---

## 간헐 실패의 공통·플랫폼별 원인

| 구분        | 원인 요약                                                                                                                                                                                                                                   |
| ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **공통**    | CI 러너는 로컬보다 **시뮬/에뮬·앱·MCP·idb/adb** 전반이 느리다. 같은 스텝이라도 타이밍에 따라 query_selector·measure·tap 중 하나가 지연되거나 실패한다.                                                                                      |
| **iOS**     | **idb `ui tap`** 이 시뮬레이터에 전달되기 전/후로 시뮬레이터가 무거우면 25초 타임아웃까지 응답이 안 나온다. `query_selector`는 성공해도 그 다음 tap 단계에서 "Command timed out"이 난다.                                                    |
| **Android** | **measure 보충**이 실패한다. 요소는 셀렉터로 찾지만, Fabric/Bridge의 `measureInWindow`·`UIManager.measure` 콜백이 CI에서 늦게 오거나 오지 않아 "has no measure data"가 난다. 화면 전환·리플로우 직후에 measure를 요청할 때 특히 불안정하다. |

즉, **iOS는 “tap 명령 타임아웃”**, **Android는 “요소는 찾았지만 좌표(measure) 수집 실패”**가 주된 간헐 원인이다. 둘 다 **CI 환경의 지연·타이밍**에서 오는 flakiness다.

---

## CI에서 하는 검사

- **Doctor**: E2E 워크플로에서 의존성 설치 후 `doctor`를 실행한다. Node ≥ 24, react-native ≥ 0.74
  미충족 시 빌드 전에 실패해 원인 파악이 빠르다.
- **Tap 타임아웃**: iOS/Android E2E job에서는 `REACT_NATIVE_MCP_TAP_TIMEOUT_MS=25000`을 사용한다.
  시뮬레이터/에뮬레이터 지연 시 10초 기본값으로는 부족할 수 있어 25초로 확대했다.

---

## 자주 나오는 실패와 대응

| 현상                           | 원인 요약                                                                                 | 대응                                                                                                                                                                                                 |
| ------------------------------ | ----------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| iOS: `Command timed out` (tap) | idb `ui tap`이 25초 안에 응답하지 않음. CI에서 시뮬레이터/idb가 간헐적으로 지연되면 발생. | tap 도구에서 타임아웃 시 1.5초 대기 후 1회 재시도. 그래도 실패하면 시뮬레이터 기기 고정([development-commands](development-commands.md#ci-e2e-시뮬레이터에뮬레이터-기기-지정)) 또는 워크플로 재실행. |
| Android: `has no measure data` | 요소는 찾았지만 measure 보충 실패(타이밍/레이아웃)                                        | 해당 스텝 직전에 `wait` 또는 `assert_visible`로 대기. 실패 시 **워크플로 재실행**으로 통과하는 경우 많음.                                                                                            |

상세 원인 분석은 [issue/ci-e2e-failure-analysis.md](issue/ci-e2e-failure-analysis.md) 참고.

---

## 재실행 권장

일시적 지연이나 측정 타이밍 이슈로 실패한 경우, GitHub Actions에서 **Re-run failed jobs** 또는 **Re-run all jobs**로
한 번 더 돌리면 통과하는 경우가 많다.

---

## 항상 성공에 가깝게 하려면

간헐 원인이 타이밍/지연이므로, **한 번 실패해도 한 번 더 시도**하면 통과할 가능성이 높다. 아래는 효과 순으로 정리한 선택지다.

| 우선순위 | 방법                       | 설명                                                                                                                                    | 부작용                                                  |
| -------- | -------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------- |
| **1**    | **CI에서 E2E 단계 재시도** | E2E YAML 테스트 실행 스텝을 실패 시 1회 재시도(예: 최대 2회 실행). 한 번의 flake를 흡수한다.                                            | 실패 시 런이 2배 길어질 수 있음(보통 첫 시도에서 성공). |
| **2**    | **Runner에서 스텝 재시도** | `runner.ts`에서 `executeStep` 실패 시 짧은 대기 후 같은 스텝을 1회 더 실행. tap/measure 타임아웃을 스텝 단위로 완화.                    | 코드 변경 필요, 모든 스텝에 재시도 적용됨.              |
| **3**    | **tap 전 measure 재조회**  | `has no measure data` 시 클라이언트에서 300ms 대기 후 `query_selector` 한 번 더 호출해 measure 보충 후 tap. Android measure flake 완화. | 서버/클라이언트 코드 변경.                              |
| **4**    | **YAML 보수적 작성**       | tap 직전 `wait`·`waitForVisible`·`waitForText`로 상태 안정화. testID 있으면 선택자로 testID 우선 사용.                                  | 스텝 수·실행 시간 증가. (이미 일부 적용됨)              |

**권장**: **1번(CI E2E 단계 재시도)**를 먼저 적용하는 것이 부담이 적고 효과가 크다. 워크플로에서 "E2E YAML 테스트 실행" 스텝을 `run`으로 감싸서 실패 시 한 번 더 실행하거나, [nick-fields/retry](https://github.com/nick-fields/retry) 같은 액션으로 감싸면 된다. 2·3번은 필요 시 추가로 검토하면 된다.
