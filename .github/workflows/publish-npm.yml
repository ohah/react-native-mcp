name: npm에 배포

on:
  push:
    tags:
      - 'react-native-mcp-server-v*'
  workflow_dispatch:
    inputs:
      version:
        description: '배포할 버전 (예: 1.0.0 또는 0.1.0-rc.2)'
        required: true
        type: string

concurrency:
  group: npm-publish
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  detect-version:
    name: 버전 감지
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.detect.outputs.version }}
      npm-tag: ${{ steps.detect.outputs.npm-tag }}
    steps:
      - name: 패키지 및 버전 감지
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            TAG_NAME="${{ github.ref_name }}"
            if [[ "$TAG_NAME" != react-native-mcp-server-v* ]]; then
              echo "알 수 없는 태그 형식: $TAG_NAME"
              exit 1
            fi
            VERSION="${TAG_NAME#react-native-mcp-server-v}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "npm-tag=latest" >> $GITHUB_OUTPUT

  publish:
    name: 서버 배포
    needs: detect-version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: 버전 일치 확인
        run: |
          CURRENT=$(node -e "console.log(require('./packages/react-native-mcp-server/package.json').version)")
          WANTED="${{ needs.detect-version.outputs.version }}"
          if [ "$CURRENT" != "$WANTED" ]; then
            echo "package.json 버전($CURRENT)과 배포 버전($WANTED)이 다릅니다."
            exit 1
          fi

      - name: Bun 설정
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: 의존성 설치
        run: bun install --frozen-lockfile

      - name: 서버 패키지 빌드
        run: bun run build

      - name: 빌드 결과 검증
        working-directory: packages/react-native-mcp-server
        run: bun dist/index.js init --help || true

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: npm에 배포
        working-directory: packages/react-native-mcp-server
        run: npm publish --tag ${{ needs.detect-version.outputs.npm-tag }} --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
