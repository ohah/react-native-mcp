name: E2E iOS

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/**'
      - 'examples/demo-app/**'
      - 'e2e/**'
      - '.github/workflows/e2e-ios.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/**'
      - 'examples/demo-app/**'
      - 'e2e/**'
      - '.github/workflows/e2e-ios.yml'

jobs:
  check:
    name: 실행 여부 확인
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.changes.outputs.e2e }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            e2e:
              - 'packages/**'
              - 'examples/demo-app/**'
              - 'e2e/**'
              - '.github/workflows/e2e-ios.yml'

  e2e-ios:
    name: E2E iOS 테스트
    needs: check
    if: needs.check.outputs.should-run == 'true'
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Bun 설정
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Bun 캐시
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: 의존성 설치
        run: bun install

      - name: Doctor (환경 검사)
        run: node ../../packages/react-native-mcp-server/scripts/doctor.mjs
        working-directory: examples/demo-app

      - name: MCP 서버 빌드
        run: bun run build

      - name: Python 3.12 설정 (fb-idb는 3.14+ 비호환)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: idb 설치
        run: |
          brew tap facebook/fb
          brew install idb-companion
          pip3 install fb-idb
          idb list-targets

      - name: Bundler 캐시
        uses: actions/cache@v4
        with:
          path: examples/demo-app/ios/vendor/bundle
          key: ${{ runner.os }}-rubygems-${{ hashFiles('examples/demo-app/ios/Gemfile') }}
          restore-keys: |
            ${{ runner.os }}-rubygems-

      - name: Ruby Bundler 설치
        run: |
          gem install bundler:2.5.9
          cd examples/demo-app/ios && bundle config set --local path 'vendor/bundle' && bundle install

      - name: iOS 앱 번들 캐시
        id: app-cache
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/e2e-app-cache/ios
          key: ${{ runner.os }}-ios-app-${{ hashFiles('examples/demo-app/ios/Podfile.lock', 'examples/demo-app/ios/**/*.pbxproj', 'examples/demo-app/ios/ReactNativeMcpDemo/**', 'examples/demo-app/package.json', 'examples/demo-app/index.js', 'examples/demo-app/metro.config.js', 'examples/demo-app/babel.config.js', 'examples/demo-app/app.json', 'examples/demo-app/tsconfig.json', 'examples/demo-app/src/**', 'examples/demo-app/react-native.config.js', 'packages/react-native-mcp-server/package.json', 'packages/react-native-mcp-server/src/**') }}
          restore-keys: |
            ${{ runner.os }}-ios-app-

      - name: CocoaPods 캐시
        if: steps.app-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            examples/demo-app/ios/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles('examples/demo-app/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: CocoaPods 설치
        if: steps.app-cache.outputs.cache-hit != 'true'
        run: bundle exec pod install
        working-directory: examples/demo-app/ios

      - name: DerivedData 캐시
        if: steps.app-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('examples/demo-app/ios/**/*.pbxproj', 'examples/demo-app/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: iOS 앱 빌드
        if: steps.app-cache.outputs.cache-hit != 'true'
        env:
          REACT_NATIVE_MCP_ENABLED: 'true'
        run: |
          xcodebuild \
            -workspace ReactNativeMcpDemo.xcworkspace \
            -scheme ReactNativeMcpDemo \
            -configuration Release \
            -sdk iphonesimulator \
            -derivedDataPath "$HOME/DerivedData" \
            -quiet
        working-directory: examples/demo-app/ios

      - name: iOS 앱 번들 캐시 저장
        if: steps.app-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p "${{ runner.temp }}/e2e-app-cache/ios"
          cp -R "$HOME/DerivedData/Build/Products/Release-iphonesimulator/"*.app "${{ runner.temp }}/e2e-app-cache/ios/"

      - name: 시뮬레이터 부팅 및 앱 설치
        env:
          # 로컬과 해상도 맞추려면: 로컬에서 사용하는 기기 이름을 설정 (예: iPhone 15)
          # 로컬 기기 이름 확인: xcrun simctl list devices available
          IOS_SIMULATOR_DEVICE_VAR: ${{ vars.IOS_SIMULATOR_DEVICE }}
        run: |
          echo "=== Available simulators (name, udid) ==="
          xcrun simctl list devices available --json | jq -r '.devices | to_entries[] | "--- \(.key) ---", (.value[] | "\(.name) | \(.udid)")"' || true

          # 기기 이름: .ios-simulator-device 파일 > vars.IOS_SIMULATOR_DEVICE > 기본 iPad Air 11-inch (M2)
          DEVICE_NAME="iPad Air 11-inch (M2)"
          if [ -n "$IOS_SIMULATOR_DEVICE_VAR" ]; then
            DEVICE_NAME="$IOS_SIMULATOR_DEVICE_VAR"
          fi
          if [ -f "examples/demo-app/e2e/.ios-simulator-device" ]; then
            READ=$(head -n 1 examples/demo-app/e2e/.ios-simulator-device | tr -d ' \r\n')
            [ -n "$READ" ] && DEVICE_NAME="$READ"
          fi
          echo "Using simulator device name: $DEVICE_NAME"

          DEVICE_UDID=$(xcrun simctl list devices available --json | jq -r --arg name "$DEVICE_NAME" '.devices | to_entries[] | .value[] | select(.name == $name) | .udid' | head -n 1)
          if [ -z "$DEVICE_UDID" ]; then
            echo "Warning: '$DEVICE_NAME' not found, falling back to first available iPhone or iPad"
            DEVICE_UDID=$(xcrun simctl list devices available --json | jq -r '.devices | to_entries[] | .value[] | select(.name | contains("iPhone") or contains("iPad")) | .udid' | head -n 1)
          fi
          if [ -z "$DEVICE_UDID" ]; then
            echo "Error: No available iPhone/iPad simulator found"
            exit 1
          fi
          echo "DEVICE_UDID=$DEVICE_UDID" >> $GITHUB_ENV

          # 시뮬레이터 부팅
          echo "Booting simulator: $DEVICE_UDID"
          xcrun simctl boot "$DEVICE_UDID" || true

          # 앱 경로: 캐시 히트 시 캐시 디렉터리, 미스 시 빌드 후 복사해 둔 캐시 디렉터리
          APP_PATH=$(find "${{ runner.temp }}/e2e-app-cache/ios" -maxdepth 2 -name "*.app" 2>/dev/null | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: No .app found in app cache"
            exit 1
          fi
          echo "Installing app: $APP_PATH"
          xcrun simctl install booted "$APP_PATH"

      - name: 시뮬레이터 세로(Portrait) 방향으로 설정
        run: |
          set -e
          # GraphicsOrientation: 1=Portrait 0°, 2=Portrait 180°, 3/4=Landscape. E2E는 1로 고정.
          read_orientation() {
            xcrun simctl spawn booted defaults read com.apple.backboardd 2>/dev/null | grep -o 'GraphicsOrientation = [0-9]*' | grep -o '[0-9]*' || echo "0"
          }
          is_portrait() {
            r=$(read_orientation)
            [ "$r" = "1" ] || [ "$r" = "2" ]
          }
          rotate_right() {
            osascript -e 'tell application "Simulator" to activate' -e 'delay 0.3' -e 'tell application "System Events" to tell process "Simulator" to click menu item "Rotate Right" of menu "Device" of menu bar 1'
          }
          # 1) Device > Orientation > Portrait으로 세로 맞추기
          osascript -e 'tell application "Simulator" to activate' -e 'delay 1' -e 'tell application "System Events" to tell process "Simulator" to click menu item "Portrait" of menu 1 of menu item "Orientation" of menu 1 of menu bar item "Device" of menu bar 1'
          for attempt in 1 2 3; do
            sleep 2
            if is_portrait; then break; fi
            echo "Attempt $attempt: GraphicsOrientation=$(read_orientation), retrying Portrait menu click..."
            osascript -e 'tell application "System Events" to tell process "Simulator" to click menu item "Portrait" of menu 1 of menu item "Orientation" of menu 1 of menu bar item "Device" of menu bar 1' || true
          done
          r=$(read_orientation)
          if [ "$r" != "1" ] && [ "$r" != "2" ]; then
            echo "Failed to set portrait. Current GraphicsOrientation=$r"
            exit 1
          fi
          # 2) 2(180°)이면 Rotate Right 반복해서 1(0°)으로 맞추기
          for _ in 1 2 3 4; do
            r=$(read_orientation)
            if [ "$r" = "1" ]; then
              echo "Orientation is GraphicsOrientation=1 (Portrait 0°)."
              exit 0
            fi
            rotate_right
            sleep 2
          done
          echo "Failed to set GraphicsOrientation=1. Current: $(read_orientation)"
          exit 1

      - name: E2E YAML 테스트 실행
        env:
          REACT_NATIVE_MCP_TAP_TIMEOUT_MS: 25000
        run: node packages/react-native-mcp-server/dist/test/cli.js run examples/demo-app/e2e/all-steps.yaml -p ios -o e2e-artifacts/yaml-results --no-auto-launch

      - name: 실패 시 스크린샷·로그 저장
        if: failure()
        timeout-minutes: 2
        run: |
          mkdir -p e2e-artifacts
          xcrun simctl io booted screenshot e2e-artifacts/failure-screenshot.png 2>/dev/null || true
          xcrun simctl spawn booted log show --last 1m 2>/dev/null | tail -n 3000 > e2e-artifacts/simulator-log.txt || true

      - name: 아티팩트 업로드
        if: failure()
        timeout-minutes: 3
        uses: actions/upload-artifact@v4
        with:
          name: e2e-ios-failure-artifacts
          path: e2e-artifacts/
          retention-days: 14
          if-no-files-found: ignore
